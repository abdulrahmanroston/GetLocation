<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
</head>

<body>
  
 <details class="location-box">
  <summary id="boxTitle">Delivery to: No location selected</summary>
  <div class="location-content">
    <button id="getLocationBtn">Get My Current Location</button>
    <button id="mapLocationBtn">Choose from Map</button>
    <div id="mapContainer" style="display:none;">
      <div id="map" style="height: 300px; width: 100%;"></div>
      <button id="saveMapLocationBtn">Save Location from Map</button>
    </div>
    <div id="locationInput" style="display:none;">
      <input type="text" id="locationName" placeholder="Enter location name (e.g., Home)" style="width: 100%; padding: 8px; margin: 5px 0;">
      <div id="locationPreview"></div>
      <button id="saveLocationBtn">Save Location</button>
    </div>
    <div id="locationList"></div>
  </div>
</details>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAFjkTsmVGgWlAhU2hKQSgeiFeKsEFYKBY&callback=initMap" async defer></script>

<style>
  .location-box {
    margin: 10px;
    max-width: 400px;
    font-family: Arial, sans-serif;
  }
  .location-box summary {
    padding: 12px 15px;
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    color: #333;
    transition: background-color 0.3s ease;
  }
  .location-box summary:hover {
    background-color: #f9f9f9;
  }
  .location-content {
    padding: 15px;
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-top: none;
    border-radius: 0 0 5px 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .location-content button {
    padding: 8px 15px;
    margin: 5px 0;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  .location-content button:hover {
    background-color: #0056b3;
  }
  #locationList {
    margin-top: 15px;
  }
  #locationList div {
    padding: 8px;
    margin: 5px 0;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    display: flex;
    align-items: center;
    transition: background-color 0.2s ease;
  }
  #locationList div:hover {
    background-color: #e9ecef;
  }
  #locationList input[type="radio"] {
    margin-right: 10px;
  }
  #locationList label {
    font-size: 14px;
    color: #333;
  }
  #locationPreview {
    margin: 5px 0;
    font-size: 14px;
    color: #666;
  }
  #mapContainer {
    margin-top: 10px;
  }
</style>

<script>
  let map, marker;
  let currentCoords = null;

  // Initialize Google Map with Cairo as default center
  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 30.0444, lng: 31.2357 }, // Cairo coordinates
      zoom: 8
    });
    marker = new google.maps.Marker({
      map: map,
      draggable: true,
      position: { lat: 30.0444, lng: 31.2357 } // Cairo coordinates
    });
    map.addListener("click", function(e) {
      marker.setPosition(e.latLng);
    });
  }

  if ("geolocation" in navigator) {
    const getLocationBtn = document.getElementById("getLocationBtn");
    const saveLocationBtn = document.getElementById("saveLocationBtn");
    const mapLocationBtn = document.getElementById("mapLocationBtn");
    const saveMapLocationBtn = document.getElementById("saveMapLocationBtn");
    const locationList = document.getElementById("locationList");
    const locationInput = document.getElementById("locationInput");
    const locationNameInput = document.getElementById("locationName");
    const locationPreview = document.getElementById("locationPreview");
    const boxTitle = document.getElementById("boxTitle");
    const mapContainer = document.getElementById("mapContainer");

    function updateTitle() {
      let locations = JSON.parse(localStorage.getItem("userLocations")) || [];
      let selectedIndex = document.querySelector('input[name="selectedLocation"]:checked');
      if (selectedIndex && locations[selectedIndex.value]) {
        boxTitle.textContent = `Delivery to: ${locations[selectedIndex.value].name}`;
      } else {
        boxTitle.textContent = "Delivery to: No location selected";
      }
    }

    getLocationBtn.addEventListener("click", function() {
      locationPreview.innerHTML = "Fetching location...";
      navigator.geolocation.getCurrentPosition(
        function(position) {
          currentCoords = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            timestamp: new Date().toLocaleString()
          };
          locationPreview.innerHTML = `Location: (${currentCoords.lat}, ${currentCoords.lng}) - ${currentCoords.timestamp}`;
          locationInput.style.display = "block";
          locationList.style.display = "none";
          mapContainer.style.display = "none";
        },
        function(error) {
          let errorMessage = "Failed to get location: ";
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage += "Permission denied. Please allow location access in settings.";
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage += "Location unavailable.";
              break;
            case error.TIMEOUT:
              errorMessage += "Request timed out. Try again.";
              break;
            default:
              errorMessage += error.message;
          }
          locationPreview.innerHTML = errorMessage;
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    });

    mapLocationBtn.addEventListener("click", function() {
      mapContainer.style.display = "block";
      locationInput.style.display = "none";
      locationList.style.display = "none";
      google.maps.event.trigger(map, "resize");
      map.setCenter({ lat: 30.0444, lng: 31.2357 }); // Center on Cairo
    });

    saveLocationBtn.addEventListener("click", function() {
      const name = locationNameInput.value.trim();
      if (name && currentCoords) {
        let locations = JSON.parse(localStorage.getItem("userLocations")) || [];
        currentCoords.name = name;
        locations.push(currentCoords);
        localStorage.setItem("userLocations", JSON.stringify(locations));
        displayLocations();
        locationInput.style.display = "none";
        locationList.style.display = "block";
        locationNameInput.value = "";
        locationPreview.innerHTML = "";
      } else {
        locationPreview.innerHTML = "Please enter a location name.";
      }
    });

    saveMapLocationBtn.addEventListener("click", function() {
      const position = marker.getPosition();
      if (position) {
        currentCoords = {
          lat: position.lat(),
          lng: position.lng(),
          timestamp: new Date().toLocaleString()
        };
        locationPreview.innerHTML = `Location: (${currentCoords.lat}, ${currentCoords.lng}) - ${currentCoords.timestamp}`;
        locationInput.style.display = "block";
        mapContainer.style.display = "none";
        locationList.style.display = "none";
      } else {
        locationPreview.innerHTML = "Please select a location on the map first.";
      }
    });

    // Display saved locations
    function displayLocations() {
      let locations = JSON.parse(localStorage.getItem("userLocations")) || [];
      locationList.innerHTML = "<h4>Saved Locations:</h4>";
      locations.forEach((loc, index) => {
        locationList.innerHTML += `
          <div>
            <input type="radio" name="selectedLocation" value="${index}" id="loc${index}" ${index === 0 && locations.length === 1 ? "checked" : ""}>
            <label for="loc${index}">${loc.name} (${loc.lat}, ${loc.lng}) - ${loc.timestamp}</label>
          </div>`;
      });
      document.querySelectorAll('input[name="selectedLocation"]').forEach(radio => {
        radio.addEventListener("change", updateTitle);
      });
      updateTitle();
    }

    displayLocations();
  } else {
    document.getElementById("locationList").innerHTML = "Browser does not support Geolocation.";
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const checkoutForm = document.querySelector('form[action="/cart"]');
    if (checkoutForm) {
      checkoutForm.addEventListener("submit", function(e) {
        let locations = JSON.parse(localStorage.getItem("userLocations")) || [];
        let selectedIndex = document.querySelector('input[name="selectedLocation"]:checked');
        if (selectedIndex) {
          let selectedLocation = locations[selectedIndex.value];
          const locationInput = document.createElement("input");
          locationInput.type = "hidden";
          locationInput.name = "attributes[SelectedLocation]";
          locationInput.value = JSON.stringify(selectedLocation);
          checkoutForm.appendChild(locationInput);
        }
      });
    }
  });
</script>
  
  <div class="content">
    Content Here
  </div>
  
  
  
</body>

</html>
